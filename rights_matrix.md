# Матрица прав Docflow

Этот документ предлагает общий подход к заполнению матрицы прав для системы Docflow, где присутствует несколько компаний, роли внутри компаний, динамические права и правила на уровне документов.

## 1. Основные сущности

- **Компания** – юридическое лицо или подразделение. Каждая компания имеет собственный набор ролей.
- **Роль** – набор полномочий пользователя внутри компании (например, `admin`, `manager`, `viewer`).
- **Тип документа** – определяет набор полей, доступные действия и состояния.
- **Действие** – операция над документом (создание, чтение, обновление, удаление, кастомные действия).

## 2. Структура матрицы прав

Предлагается хранить матрицу прав в формате JSON. Для каждой компании и типа документа описываются права по действиям и ролям. Пример базовой структуры:

```json
{
  "CompanyA": {
    "DocA": {
      "create": {"admin": true, "manager": true},
      "read":   {"admin": true, "manager": true, "viewer": true},
      "update": {"admin": true},
      "delete": {"admin": true}
    }
  },
  "CompanyB": {
    "DocA": {
      "create": {"admin": true},
      "read":   {"admin": true, "viewer": true},
      "update": {"admin": true, "manager": true},
      "delete": {"admin": true}
    }
  }
}
```

Здесь ключ первого уровня – идентификатор компании, второго – имя типа документа, третьего – действие. Значением является словарь ролей с булевыми флагами.

## 3. Динамические права

Для описания условий допуска по значениям полей документа или другим параметрам можно ввести структуру с условиями. Например:

```json
"update": [
  {"role": "manager", "allow": "doc.status == 'DRAFT'"},
  {"role": "admin", "allow": true}
]
```

Каждый элемент списка представляет правило. Поле `allow` может быть либо булевым значением, либо выражением, которое вычисляется в контексте документа и пользователя. Таким образом, менеджер может менять документ только в состоянии `DRAFT`, а администратор – всегда.

Логика вычисления условий реализуется отдельным интерпретатором, который подставляет значения полей документа и параметры пользователя.

## 4. Правила отображения и редактирования полей

На уровне документа можно определить, какие поля показывать пользователю и какие разрешены к редактированию. Правила также могут зависеть от значений других полей.

Пример описания поля:

```json
{
  "id": "paymentDate",
  "type": "date",
  "show": [
    {"role": "manager", "if": "doc.status == 'APPROVED'"},
    {"role": "admin", "if": true}
  ],
  "edit": [
    {"role": "manager", "if": "doc.status == 'DRAFT'"},
    {"role": "admin", "if": true}
  ]
}
```

- **show** – список правил, определяющих возможность просмотра поля.
- **edit** – список правил для редактирования.

В приведённом примере поле `paymentDate` видно менеджеру только в одобренных документах, а редактировать его менеджер может лишь на стадии черновика. Администратор имеет доступ всегда.

## 5. Рекомендации по заполнению

1. Определите список компаний и их роли. Чаще всего роли одинаковы (admin, manager, viewer), но могут отличаться.
2. Для каждого типа документа укажите базовые права по действиям в разрезе компаний и ролей.
3. При необходимости вводите динамические права в форме условий (`allow`).
4. Для полей документов описывайте правила отображения (`show`) и редактирования (`edit`) с учётом значения других полей.
5. Поддерживайте единый формат конфигурации, чтобы его могла обрабатывать система Docflow.

Используя такую матрицу прав, можно гибко настраивать доступ в многокомпанийной среде, учитывая роли и состояния документов, а также изменяя поведение в зависимости от значений полей.
