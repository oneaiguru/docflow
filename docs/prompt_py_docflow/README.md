# Промпт для генерации кода на основе py_docflow

Данный каталог содержит инструкцию по созданию описаний типов документов, на базе которых можно сгенерировать Python-код, совместимый с модулем `py_docflow`. Пример реализации хранится в каталоге `py_docflow` и состоит из нескольких модулей:

- **document.py** – набор классов документов. В их числе базовый `Document`, расширяемые варианты `DocumentSimple` и `DocumentVersioned`, класс для работы с файлами `DocumentFile` и запись истории `DocumentHistoryEntry`.
- **doctypes.py** – описание структуры типа документа (`DocType`), класс `Action` для пользовательских операций и реестр `DocTypesRegistry` для загрузки конфигураций из JSON.
- **docflow.py** – высокоуровневый движок `Docflow`, который выполняет операции над документами, ведёт историю изменений и проверяет права доступа.
- **storage.py** – простое хранилище в памяти `InMemoryStorage` и менеджер транзакций `Transaction`, обеспечивающий откат при ошибках.
- **user.py** – простая модель пользователя `User` с ролями.

### Формат описания типа документа
Ниже приведён шаблон запроса к языковой модели. Структура разбита на обязательные и опциональные разделы. Дополнительные поля можно опустить, если они не требуются.

```json
{
  "name": "Invoice",
  "fields": [
    {"id": "number", "type": "string"},
    {"id": "date", "type": "date"},
    {"id": "total", "type": "decimal"}
  ],
  "states": ["NEW", "APPROVED"],
  "actions": [
    {"name": "APPROVE", "service": false}
  ],
  "rights": {
    "create": {"admin": true},
    "approve": {"manager": true}
  },
  "links": {"Payment": "payment_id"},
  "history": true,
  "validations": []
}
```

**Обязательные поля**
1. `name` – уникальное название документа.
2. `fields` – список атрибутов и их типы.

**Опциональные разделы**
- `states` – возможные состояния (`NEW`, `UPDATED` и т.д.).
- `actions` – пользовательские операции. Если `service` равен `true`, действие является внутренним.
- `rights` – роли и права на действия. Ключами выступают имена операций.
- `links` – связи с другими типами документов.
- `history` – `true`, если требуется вести версии и историю изменений.
- `validations` – правила проверки данных при сохранении.

### Использование py_docflow
После создания описания типа документа его можно загрузить через `DocTypesRegistry` и использовать вместе с классом `Docflow`. Пример демонстрации находится в файле `py_docflow_demo.py`. В нём создаются два документа, выполняются действия `LINK` и `MARK`, демонстрируется история изменений и работа прав доступа.

Главные возможности движка:
- создание и обновление версионных документов (`Docflow.create`, `Docflow.update`);
- сохранение и получение файловых документов (`Docflow.persist_file`, `Docflow.get_file`);
- кастомные действия с поддержкой цепочек и транзакций (`Docflow.action`);
- проверка прав пользователей перед выполнением операций;
- хранение истории изменений и возможность восстановления удалённых документов (`Docflow.recover`).

Запустить пример можно так:

```bash
python -m py_docflow_demo
```

Также в каталоге `tests` содержатся тесты `pytest`, которые покрывают основные сценарии работы: создание и историю версий, обновление и ревизии, выполнение пользовательских действий, контроль прав и восстановление удалённых записей.

Такое описание позволяет формировать универсальные конфигурации документов, которые затем можно применить для генерации кода на Python, Java или любых других языках.
